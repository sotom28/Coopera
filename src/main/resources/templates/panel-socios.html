<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Socios - Coopera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .controls {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            flex: 1;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            min-width: 300px;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-export {
            background: #28a745;
            color: white;
        }
        
        .btn-export:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-clear {
            background: #6c757d;
            color: white;
        }
        
        .btn-clear:hover {
            background: #5a6268;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        .table-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .table-info span {
            color: #666;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9em;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.005);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        td {
            padding: 15px 10px;
            color: #333;
            white-space: nowrap;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-activo {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-inactivo {
            background: #f8d7da;
            color: #721c24;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            display: none;
        }
        
        .footer {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            color: #666;
            font-size: 0.9em;
        }
        
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            table {
                font-size: 0.8em;
            }
            
            th, td {
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Panel de Socios</h1>
            <p>Sistema de Gesti√≥n de Cooperativas</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3 th:text="${#lists.size(socios)}">0</h3>
                <p>Total de Socios</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-visible">0</h3>
                <p>Socios Visibles</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-activos">0</h3>
                <p>Socios Activos</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-inactivos">0</h3>
                <p>Socios Inactivos</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por RUT, nombre, apellido, email, tel√©fono...">
                </div>
                <select id="filterColumn" class="filter-select">
                    <option value="all">Buscar en todos los campos</option>
                    <option value="0">RUT</option>
                    <option value="1">Nombres</option>
                    <option value="2">Apellido Paterno</option>
                    <option value="3">Apellido Materno</option>
                    <option value="4">Email</option>
                    <option value="5">Tel√©fono</option>
                    <option value="6">Celular</option>
                </select>
            </div>
            <button class="btn btn-clear" onclick="clearSearch()">
                üîÑ Limpiar
            </button>
            <label style="display:flex;align-items:center;gap:8px;color:#555">
                <input type="checkbox" id="autoRefresh" /> Auto-actualizar (15s)
            </label>
            <button class="btn btn-primary" onclick="fetchSocios(true)">
                ‚Üª Actualizar ahora
            </button>
            <button class="btn btn-export" onclick="exportToCSV()">
                üì• Exportar CSV
            </button>
        </div>
        
        <div class="table-container">
            <div class="table-info">
                <span>üìä Mostrando: <span id="showing-count">0</span> de <span id="total-count" th:text="${#lists.size(socios)}">0</span> socios</span>
                <span>üîç Filtrado por: <span id="current-filter">Todos los campos</span></span>
            </div>
            
            <div class="no-results" id="noResults">
                <h3>üòï No se encontraron resultados</h3>
                <p>Intenta con otros t√©rminos de b√∫squeda</p>
            </div>
            
            <table id="sociosTable">
                <thead>
                    <tr>
                        <th>RUT</th>
                        <th>Nombres</th>
                        <th>Ap. Paterno</th>
                        <th>Ap. Materno</th>
                        <th>Email</th>
                        <th>Tel√©fono</th>
                        <th>Celular</th>
                        <th>Direcci√≥n</th>
                        <th>Fecha Ingreso</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${#lists.isEmpty(socios)}">
                        <td colspan="10">
                            <div class="empty-state">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <h2>No hay socios registrados</h2>
                                <p>Los socios aparecer√°n aqu√≠ cuando sean registrados en el sistema</p>
                            </div>
                        </td>
                    </tr>
                    <tr th:each="socio : ${socios}">
                        <td th:text="${socio.numrun != null ? socio.numrun + '-' + (socio.dvrun != null ? socio.dvrun : '') : '-'}">-</td>
                        <td th:text="${(socio.Pnombre != null ? socio.Pnombre : '') + ' ' + (socio.Snombre != null ? socio.Snombre : '')}">-</td>
                        <td th:text="${socio.appaterno != null ? socio.appaterno : '-'}">-</td>
                        <td th:text="${socio.apmaterno != null ? socio.apmaterno : '-'}">-</td>
                        <td th:text="${socio.correo != null ? socio.correo : '-'}">-</td>
                        <td th:text="${socio.fono_contacto != null ? socio.fono_contacto : '-'}">-</td>
                        <td>-</td>
                        <td th:text="${socio.direccion != null ? socio.direccion : '-'}">-</td>
                        <td th:text="${socio.fechaIngreso != null ? #dates.format(socio.fechaIngreso, 'dd/MM/yyyy') : '-'}">-</td>
                        <td>
                            <span class="badge badge-activo">Activo</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <p>¬© 2025 Sistema Coopera - Todos los derechos reservados</p>
        </div>
    </div>
    
    <script>
    const searchInput = document.getElementById('searchInput');
        const filterColumn = document.getElementById('filterColumn');
        const table = document.getElementById('sociosTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = tbody.getElementsByTagName('tr');
        const noResults = document.getElementById('noResults');
        const showingCount = document.getElementById('showing-count');
        const totalCount = document.getElementById('total-count');
        const currentFilter = document.getElementById('current-filter');
    const autoRefresh = document.getElementById('autoRefresh');
    const API_SOCIOS = '/api/v2/socios';
        
        // Actualizar estad√≠sticas al cargar
        window.addEventListener('load', function() {
            updateStats();
            updateShowingCount();
            // primer fetch para asegurar datos frescos
            fetchSocios(false);
            // auto refresh cada 15s si est√° habilitado
            setInterval(() => { if (autoRefresh.checked) fetchSocios(false); }, 15000);
        });

        async function fetchSocios(showToast){
            try{
                const res = await fetch(API_SOCIOS, { headers: { 'Accept': 'application/json' } });
                if(!res.ok) return;
                const data = await res.json();
                renderSocios(data);
                totalCount.textContent = (data?.length || 0).toLocaleString('es-CL');
                performSearch();
            }catch(err){
                console.warn('No se pudo actualizar socios', err);
            }
        }

        function renderSocios(list){
            if(!Array.isArray(list)) return;
            const html = list.map(socio => {
                const rut = (socio.numrun != null ? socio.numrun : '') + (socio.dvrun ? '-' + socio.dvrun : '');
                const nombres = (socio.pnombre ?? socio.Pnombre ?? '') + ' ' + (socio.snombre ?? socio.Snombre ?? '');
                const app = socio.appaterno ?? '-';
                const apm = socio.apmaterno ?? '-';
                const correo = socio.correo ?? '-';
                const fono = socio.fono_contacto ?? '-';
                const dir = socio.direccion ?? '-';
                const fecha = socio.fechaIngreso ? new Date(socio.fechaIngreso).toLocaleDateString('es-CL') : '-';
                return `<tr>
                        <td>${rut || '-'}</td>
                        <td>${(nombres || '').trim()}</td>
                        <td>${app}</td>
                        <td>${apm}</td>
                        <td>${correo}</td>
                        <td>${fono}</td>
                        <td>-</td>
                        <td>${dir}</td>
                        <td>${fecha}</td>
                        <td><span class="badge badge-activo">Activo</span></td>
                    </tr>`;
            }).join('');
            tbody.innerHTML = html || tbody.innerHTML; // si vac√≠o, conserva existente
            updateStats();
            updateShowingCount();
        }
        
        // B√∫squeda en tiempo real
        searchInput.addEventListener('keyup', performSearch);
        filterColumn.addEventListener('change', function() {
            const filterText = filterColumn.options[filterColumn.selectedIndex].text;
            currentFilter.textContent = filterText;
            performSearch();
        });
        
        function performSearch() {
            const searchValue = searchInput.value.toLowerCase();
            const columnIndex = filterColumn.value;
            let visibleCount = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // Saltar filas vac√≠as o de estado vac√≠o
                if (row.cells.length < 2) {
                    continue;
                }
                
                let shouldShow = false;
                
                if (columnIndex === 'all') {
                    // Buscar en todas las columnas
                    const text = row.textContent.toLowerCase();
                    shouldShow = text.includes(searchValue);
                } else {
                    // Buscar en columna espec√≠fica
                    const cellText = row.cells[parseInt(columnIndex)].textContent.toLowerCase();
                    shouldShow = cellText.includes(searchValue);
                }
                
                if (shouldShow || searchValue === '') {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
            
            // Mostrar mensaje de "no resultados"
            if (visibleCount === 0 && searchValue !== '') {
                noResults.style.display = 'block';
                table.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                table.style.display = 'table';
            }
            
            // Actualizar contador
            showingCount.textContent = visibleCount;
            document.getElementById('stat-visible').textContent = visibleCount;
        }
        
        function clearSearch() {
            searchInput.value = '';
            filterColumn.value = 'all';
            currentFilter.textContent = 'Todos los campos';
            performSearch();
        }
        
        function updateStats() {
            let activos = 0;
            let inactivos = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (row.cells.length < 2) continue;
                
                const estadoCell = row.cells[9];
                if (estadoCell && estadoCell.textContent.includes('Activo')) {
                    activos++;
                } else if (estadoCell && estadoCell.textContent.includes('Inactivo')) {
                    inactivos++;
                }
            }
            
            document.getElementById('stat-activos').textContent = activos;
            document.getElementById('stat-inactivos').textContent = inactivos;
        }
        
        function updateShowingCount() {
            let visible = 0;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].style.display !== 'none' && rows[i].cells.length >= 2) {
                    visible++;
                }
            }
            showingCount.textContent = visible;
            document.getElementById('stat-visible').textContent = visible;
        }
        
        // Exportar a CSV
        function exportToCSV() {
            const table = document.getElementById('sociosTable');
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            for (let i = 0; i < rows.length; i++) {
                // Solo exportar filas visibles
                if (rows[i].style.display === 'none') continue;
                
                const row = [], cols = rows[i].querySelectorAll('td, th');
                
                for (let j = 0; j < cols.length; j++) {
                    // Limpiar y escapar el texto
                    let text = cols[j].innerText.replace(/"/g, '""');
                    row.push('"' + text + '"');
                }
                
                csv.push(row.join(','));
            }
            
            // Crear archivo CSV
            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const downloadLink = document.createElement('a');
            downloadLink.download = 'socios_coopera_' + new Date().toISOString().slice(0,10) + '.csv';
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    </script>
</body>
</html>
