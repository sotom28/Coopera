<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Socios - Coopera</title>
    <style>
        /* ...todo tu CSS original aqu√≠, sin cambios... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }
        .controls {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-container {
            flex: 1;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            min-width: 300px;
        }
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s;
        }
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .filter-select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-export {
            background: #28a745;
            color: white;
        }
        .btn-export:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        .btn-clear {
            background: #6c757d;
            color: white;
        }
        .btn-clear:hover {
            background: #5a6268;
        }
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        .table-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .table-info span {
            color: #666;
            font-weight: 600;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9em;
        }
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.005);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        td {
            padding: 15px 10px;
            color: #333;
            white-space: nowrap;
        }
        .badge {
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }
        .badge-activo {
            background: #d4edda;
            color: #155724;
        }
        .badge-inactivo {
            background: #f8d7da;
            color: #721c24;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            display: none;
        }
        .footer {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            color: #666;
            font-size: 0.9em;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            .stats {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
            }
            table {
                font-size: 0.8em;
            }
            th, td {
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Panel de Socios</h1>
            <p>Sistema de Gesti√≥n de Cooperativas</p>
        </div>
        <div class="stats">
            <div class="stat-card">
                <h3 id="total-count">0</h3>
                <p>Total de Socios</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-visible">0</h3>
                <p>Socios Visibles</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-activos">0</h3>
                <p>Socios Activos</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-inactivos">0</h3>
                <p>Socios Inactivos</p>
            </div>
        </div>
        <div class="controls">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por RUT, nombre, apellido, email, tel√©fono...">
                </div>
                <select id="filterColumn" class="filter-select">
                    <option value="all">Buscar en todos los campos</option>
                    <option value="0">RUT</option>
                    <option value="1">Nombres</option>
                    <option value="2">Apellido Paterno</option>
                    <option value="3">Apellido Materno</option>
                    <option value="4">Email</option>
                    <option value="5">Tel√©fono</option>
                    <option value="6">Celular</option>
                </select>
            </div>
            <button class="btn btn-primary" id="btnNuevoSocio">
                ‚ûï Nuevo socio
            </button>
            <button class="btn btn-clear" onclick="clearSearch()">
                üîÑ Limpiar
            </button>
            <label style="display:flex;align-items:center;gap:8px;color:#555">
                <input type="checkbox" id="autoRefresh" /> Auto-actualizar (15s)
            </label>
            <button class="btn btn-primary" onclick="fetchSocios(true)">
                ‚Üª Actualizar ahora
            </button>
            <button class="btn btn-export" onclick="exportToCSV()">
                üì• Exportar CSV
            </button>
        </div>
        <div class="table-container">
            <div class="table-info">
                <span>üìä Mostrando: <span id="showing-count">0</span> de <span id="total-count">0</span> socios</span>
                <span>üîç Filtrado por: <span id="current-filter">Todos los campos</span></span>
            </div>
            <div class="no-results" id="noResults">
                <h3>üòï No se encontraron resultados</h3>
                <p>Intenta con otros t√©rminos de b√∫squeda</p>
            </div>
            <table id="sociosTable">
                <thead>
                    <tr>
                        <th>RUT</th>
                        <th>Nombres</th>
                        <th>Ap. Paterno</th>
                        <th>Ap. Materno</th>
                        <th>Email</th>
                        <th>Tel√©fono</th>
                        <th>Celular</th>
                        <th>Direcci√≥n</th>
                        <th>Fecha Ingreso</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas se llenan solo por JS -->
                </tbody>
            </table>
        </div>
        <div class="footer">
            <p>¬© 2025 Sistema Coopera - Todos los derechos reservados</p>
        </div>
    </div>
    <!-- Modal Nuevo Socio -->
    <div id="modalOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;">
        <div style="background:#fff;max-width:900px;margin:40px auto;padding:20px 24px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h2>‚ûï Nuevo Socio</h2>
                <button id="closeModal" class="btn btn-clear">‚úñ Cerrar</button>
            </div>
            <form id="formNuevoSocio" onsubmit="return false;">
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
                    <div>
                        <label>RUN (sin DV)</label>
                        <input type="number" id="numrun" class="filter-select" style="width:100%">
                    </div>
                    <div>
                        <label>DV</label>
                        <input type="text" id="dvrun" maxlength="1" class="filter-select" style="width:100%">
                    </div>
                    <div>
                        <label>Primer Nombre</label>
                        <input type="text" id="pnombre" class="filter-select" style="width:100%">
                    </div>
                    <div>
                        <label>Segundo Nombre</label>
                        <input type="text" id="snombre" class="filter-select" style="width:100%">
                    </div>
                    <div>
                        <label>Apellido Paterno</label>
                        <input type="text" id="appaterno" class="filter-select" style="width:100%">
                    </div>
                    <div>
                        <label>Apellido Materno</label>
                        <input type="text" id="apmaterno" class="filter-select" style="width:100%">
                    </div>
                    <div>
                        <label>Correo</label>
                        <input type="email" id="correo" class="filter-select" style="width:100%">
                    </div>
                    <div>
                        <label>Fono Contacto</label>
                        <input type="number" id="fono_contacto" class="filter-select" style="width:100%">
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label>Direcci√≥n</label>
                        <input type="text" id="direccion" class="filter-select" style="width:100%">
                    </div>
                    <div>
                        <label>Fecha Ingreso</label>
                        <input type="date" id="fechaIngreso" class="filter-select" style="width:100%">
                    </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;">
                    <button class="btn btn-clear" type="button" id="btnCancelar">Cancelar</button>
                    <button class="btn btn-primary" type="submit" id="btnGuardarSocio">Guardar</button>
                </div>
                <p id="msgNuevoSocio" style="margin-top:10px;color:#555"></p>
            </form>
        </div>
    </div>
    <script>
        // ...todo tu JS original, sin cambios...
        const searchInput = document.getElementById('searchInput');
        const filterColumn = document.getElementById('filterColumn');
        const table = document.getElementById('sociosTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = tbody.getElementsByTagName('tr');
        const noResults = document.getElementById('noResults');
        const showingCount = document.getElementById('showing-count');
        const totalCount = document.getElementById('total-count');
        const currentFilter = document.getElementById('current-filter');
        const autoRefresh = document.getElementById('autoRefresh');
        const API_SOCIOS = '/api/socios';
        const API_SOCIOS_CREATE_WITH_USER = '/api/socios/create-with-user';

        window.addEventListener('load', function() {
            updateStats();
            updateShowingCount();
            fetchSocios(false);
            setInterval(() => { if (autoRefresh.checked) fetchSocios(false); }, 15000);
        });

        async function fetchSocios(showToast){
            try{
                const res = await fetch(API_SOCIOS, { headers: { 'Accept': 'application/json' } });
                if(!res.ok) return;
                const data = await res.json();
                renderSocios(data);
                totalCount.textContent = (data?.length || 0).toLocaleString('es-CL');
                performSearch();
            }catch(err){
                console.warn('No se pudo actualizar socios', err);
            }
        }

        // Abrir/cerrar modal
        const modalOverlay = document.getElementById('modalOverlay');
        const btnNuevoSocio = document.getElementById('btnNuevoSocio');
        const closeModal = document.getElementById('closeModal');
        const btnCancelar = document.getElementById('btnCancelar');
        const formNuevo = document.getElementById('formNuevoSocio');
        const msgNuevo = document.getElementById('msgNuevoSocio');

        function openModal(){ modalOverlay.style.display = 'block'; msgNuevo.textContent=''; }
        function closeModalFn(){ modalOverlay.style.display = 'none'; formNuevo.reset(); }
        if(btnNuevoSocio) btnNuevoSocio.addEventListener('click', openModal);
        if(closeModal) closeModal.addEventListener('click', closeModalFn);
        if(btnCancelar) btnCancelar.addEventListener('click', closeModalFn);

        formNuevo?.addEventListener('submit', async (e) => {
            e.preventDefault();
            msgNuevo.textContent = 'Guardando...';
            const socio = buildSocioFromForm();
            try{
                const res = await fetch(API_SOCIOS_CREATE_WITH_USER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(socio)
                });
                if(!res.ok){
                    const txt = await res.text();
                    throw new Error('Error al guardar socio: ' + txt);
                }
                const data = await res.json();
                const uc = data?.usuarioClave;
                msgNuevo.textContent = 'Socio guardado correctamente.';
                alert('Usuario creado para el socio:\nUsuario: ' + (uc?.nombreUsuario||'-') + '\nClave: ' + (uc?.claveUsuario||'-'));
                closeModalFn();
                fetchSocios(true);
            }catch(err){
                console.error(err);
                msgNuevo.textContent = 'No se pudo guardar el socio. ' + err.message;
            }
        });

        function buildSocioFromForm(){
            const numrun = document.getElementById('numrun').value ? parseInt(document.getElementById('numrun').value,10) : null;
            const dvrun = (document.getElementById('dvrun').value||'').trim().toUpperCase();
            const pnombre = (document.getElementById('pnombre').value||'').trim();
            const snombre = (document.getElementById('snombre').value||'').trim();
            const appaterno = (document.getElementById('appaterno').value||'').trim();
            const apmaterno = (document.getElementById('apmaterno').value||'').trim();
            const correo = (document.getElementById('correo').value||'').trim();
            const fono = document.getElementById('fono_contacto').value ? parseInt(document.getElementById('fono_contacto').value,10) : null;
            const direccion = (document.getElementById('direccion').value||'').trim();
            const fechaIngreso = document.getElementById('fechaIngreso').value || null; // ISO yyyy-MM-dd

            return {
                numrun: numrun,
                dvrun: dvrun,
                pnombre: pnombre,
                snombre: snombre,
                appaterno: appaterno,
                apmaterno: apmaterno,
                correo: correo,
                fono_contacto: fono,
                direccion: direccion,
                fechaIngreso: fechaIngreso
            };
        }

        function renderSocios(list){
            if(!Array.isArray(list)) return;
            const html = list.map(socio => {
                const rut = (socio.numrun != null ? socio.numrun : '') + (socio.dvrun ? '-' + socio.dvrun : '');
                const nombres = (socio.pnombre ?? socio.Pnombre ?? '') + ' ' + (socio.snombre ?? socio.Snombre ?? '');
                const app = socio.appaterno ?? '-';
                const apm = socio.apmaterno ?? '-';
                const correo = socio.correo ?? '-';
                const fono = socio.fono_contacto ?? '-';
                const dir = socio.direccion ?? '-';
                const fecha = socio.fechaIngreso ? new Date(socio.fechaIngreso).toLocaleDateString('es-CL') : '-';
                return `<tr>
                        <td>${rut || '-'}</td>
                        <td>${(nombres || '').trim()}</td>
                        <td>${app}</td>
                        <td>${apm}</td>
                        <td>${correo}</td>
                        <td>${fono}</td>
                        <td>-</td>
                        <td>${dir}</td>
                        <td>${fecha}</td>
                        <td><span class="badge badge-activo">Activo</span></td>
                    </tr>`;
            }).join('');
            tbody.innerHTML = html;
            updateStats();
            updateShowingCount();
        }

        searchInput.addEventListener('keyup', performSearch);
        filterColumn.addEventListener('change', function() {
            const filterText = filterColumn.options[filterColumn.selectedIndex].text;
            currentFilter.textContent = filterText;
            performSearch();
        });

        function performSearch() {
            const searchValue = searchInput.value.toLowerCase();
            const columnIndex = filterColumn.value;
            let visibleCount = 0;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (row.cells.length < 2) continue;
                let shouldShow = false;
                if (columnIndex === 'all') {
                    const text = row.textContent.toLowerCase();
                    shouldShow = text.includes(searchValue);
                } else {
                    const cellText = row.cells[parseInt(columnIndex)].textContent.toLowerCase();
                    shouldShow = cellText.includes(searchValue);
                }
                if (shouldShow || searchValue === '') {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
            if (visibleCount === 0 && searchValue !== '') {
                noResults.style.display = 'block';
                table.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                table.style.display = 'table';
            }
            showingCount.textContent = visibleCount;
            document.getElementById('stat-visible').textContent = visibleCount;
        }

        function clearSearch() {
            searchInput.value = '';
            filterColumn.value = 'all';
            currentFilter.textContent = 'Todos los campos';
            performSearch();
        }

        function updateStats() {
            let activos = 0;
            let inactivos = 0;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (row.cells.length < 2) continue;
                const estadoCell = row.cells[9];
                if (estadoCell && estadoCell.textContent.includes('Activo')) {
                    activos++;
                } else if (estadoCell && estadoCell.textContent.includes('Inactivo')) {
                    inactivos++;
                }
            }
            document.getElementById('stat-activos').textContent = activos;
            document.getElementById('stat-inactivos').textContent = inactivos;
        }

        function updateShowingCount() {
            let visible = 0;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].style.display !== 'none' && rows[i].cells.length >= 2) {
                    visible++;
                }
            }
            showingCount.textContent = visible;
            document.getElementById('stat-visible').textContent = visible;
        }

        function exportToCSV() {
            const table = document.getElementById('sociosTable');
            let csv = [];
            const rows = table.querySelectorAll('tr');
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].style.display === 'none') continue;
                const row = [], cols = rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) {
                    let text = cols[j].innerText.replace(/"/g, '""');
                    row.push('"' + text + '"');
                }
                csv.push(row.join(','));
            }
            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const downloadLink = document.createElement('a');
            downloadLink.download = 'socios_coopera_' + new Date().toISOString().slice(0,10) + '.csv';
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    </script>
</body>
</html>